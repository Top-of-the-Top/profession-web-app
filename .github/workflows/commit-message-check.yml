name: Commit Message Check
on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  check-commit-message:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Get all commits in PR
        id: get_commits
        run: |
          # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∫–æ–º–º–∏—Ç—ã –≤ PR
          COMMITS=$(git log --oneline origin/${{ github.base_ref }}..HEAD | wc -l)
          echo "total_commits=$COMMITS" >> $GITHUB_OUTPUT
          echo "Checking $COMMITS commits in this PR"
      
      - name: Check each commit
        run: |
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–π –∫–æ–º–º–∏—Ç –≤ PR
          git log --format="%H %s" origin/${{ github.base_ref }}..HEAD | while read hash message; do
            echo ""
            echo "üîç Checking commit: $message"
            
            # 1. –ù–µ –ø—É—Å—Ç–æ–π
            if [[ -z "$message" ]]; then
              echo "‚ùå Commit message is empty"
              exit 1
            fi
            
            # 2. –ú–∞–∫—Å 72 —Å–∏–º–≤–æ–ª–∞ –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–∞
            if [[ ${#message} -gt 72 ]]; then
              echo "‚ùå Commit header too long: ${#message} chars (max 72)"
              exit 1
            fi
            
            # 3. –ù–µ –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è —Ç–æ—á–∫–æ–π
            if [[ "$message" == *"." ]]; then
              echo "‚ùå Commit must not end with a period"
              exit 1
            fi
            
            # 4. Conventional Commits –¥–ª—è –Ω–∞—à–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞
            if [[ ! "$message" =~ ^(feat|fix|docs|style|refactor|test|chore|build|ci|perf)(\([a-z-]+\))?:[[:space:]].+$ ]]; then
              echo "‚ùå Invalid commit format"
              echo "   Expected: type(scope): description"
              echo "   Types: feat|fix|docs|style|refactor|test|chore|build|ci|perf"
              echo "   Scope (optional): frontend, backend, auth, video, etc."
              echo "   Example: feat(frontend): add landing page"
              exit 1
            fi
            
            echo "‚úÖ Valid commit"
          done
          
          echo ""
          echo "üéâ All commits are valid!"