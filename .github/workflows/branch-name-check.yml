name: Branch Name Check
on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  check-branch-name:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract branch name
        id: get_branch
        run: |
          BRANCH_NAME="${{ github.event.pull_request.head.ref }}"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
      
      - name: Check - branch name is not empty
        run: |
          BRANCH="${{ steps.get_branch.outputs.branch_name }}"
          if [[ -z "$BRANCH" ]]; then
            echo "‚ùå Branch name is empty"
            exit 1
          fi
          echo "‚úÖ Branch name isn't empty"
      
      - name: Check whether no trailing hyphen
        run: |
          BRANCH="${{ steps.get_branch.outputs.branch_name }}"
          if [[ "$BRANCH" == *"-" ]]; then
            echo "‚ùå Branch name must not end with a hyphen"
            exit 1
          elif [[ "$BRANCH" == *"/" ]]; then
            echo "‚ùå Branch name must not end with a slash"
            exit 1
          fi
          echo "‚úÖ Branch name doesn't end with hyphen or slash"
      
      - name: Check - lowercase and hyphens only
        run: |
          BRANCH="${{ steps.get_branch.outputs.branch_name }}"
          if [[ "$BRANCH" =~ ^[a-z0-9/-]+$ ]]; then
            echo "‚úÖ Only allowed characters used"
          else
            echo "‚ùå Branch contains disallowed characters (uppercase, spaces, special chars)"
            exit 1
          fi
      
      - name: Check - valid branch format (–û–ë–ù–û–í–õ–ï–ù–û!)
        run: |
          BRANCH="${{ steps.get_branch.outputs.branch_name }}"
          # –ù–û–í–´–ï –ü–†–ï–§–ò–ö–°–´ –î–õ–Ø –ü–†–û–ï–ö–¢–ê "–ü–†–û–§–ï–°–°–ò–Ø":
          # - feature, fix, hotfix - –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
          # - docs, guides - –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏  
          # - chore - –¥–ª—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã
          # - frontend, backend, infra - scope –æ–±–ª–∞—Å—Ç–∏
          regex='^((feature|fix|hotfix|refactor|test)/(frontend|backend|infra|api|video|ai)|docs|guides|chore|general|meetings)/(add|update|fix|refactor|remove|workflow|setup)(-[a-z0-9]+(-[a-z0-9]+)*[a-z0-9])?$'
          
          if ! [[ "$BRANCH" =~ $regex ]]; then
            echo "‚ùå Invalid branch format"
            echo ""
            echo "üìå –î–õ–Ø –†–ê–ó–†–ê–ë–û–¢–ö–ò:"
            echo "  feature/frontend/landing-page"
            echo "  fix/backend/auth-bug"
            echo "  hotfix/video-call-crash"
            echo "  refactor/frontend/components"
            echo "  test/backend/api-tests"
            echo ""
            echo "üìå –î–õ–Ø –î–û–ö–£–ú–ï–ù–¢–ê–¶–ò–ò –ò –ò–ù–§–†–ê–°–¢–†–£–ö–¢–£–†–´:"
            echo "  docs/add-api-docs"
            echo "  guides/add-contributing"
            echo "  chore/setup-ci-workflow"
            echo "  general/update-readme"
            echo "  meetings/add-sprint-review"
            echo ""
            echo "üìå –ü–†–ê–í–ò–õ–ê:"
            echo "  - –§–æ—Ä–º–∞—Ç: <–ø—Ä–µ—Ñ–∏–∫—Å>/<–¥–µ–π—Å—Ç–≤–∏–µ>-<–æ–ø–∏—Å–∞–Ω–∏–µ>"
            echo "  - –î–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏: <—Ç–∏–ø>/<–æ–±–ª–∞—Å—Ç—å>/<–æ–ø–∏—Å–∞–Ω–∏–µ>"
            echo "  - –¢–æ–ª—å–∫–æ lowercase, —Ü–∏—Ñ—Ä—ã, –¥–µ—Ñ–∏—Å—ã"
            echo "  - 2-6 —Å–ª–æ–≤ –≤ –æ–ø–∏—Å–∞–Ω–∏–∏"
            exit 1
          fi
          echo "‚úÖ Branch format is correct"
      
      - name: Check - total word count (3-6 words)
        run: |
          BRANCH="${{ steps.get_branch.outputs.branch_name }}"
          # –°—á–∏—Ç–∞–µ–º —Å–ª–æ–≤–∞ –≤–æ –í–°–ï–ô –≤–µ—Ç–∫–µ (–∑–∞–º–µ–Ω—è–µ–º / –∏ - –Ω–∞ –ø—Ä–æ–±–µ–ª—ã)
          WORD_COUNT=$(echo "$BRANCH" | tr '/-' ' ' | wc -w)
          
          if [[ $WORD_COUNT -lt 2 ]]; then
            echo "‚ùå Branch name too short: $WORD_COUNT words (min 3 words)"
            echo "   Example: docs/add-meeting-guide (4 words)"
            exit 1
          fi
          if [[ $WORD_COUNT -gt 6 ]]; then
            echo "‚ùå Branch name too long: $WORD_COUNT words (max 6 words)"
            exit 1
          fi
          echo "‚úÖ Total word count: $WORD_COUNT words"