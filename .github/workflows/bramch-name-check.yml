name: Branch Name Check
on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  check-branch-name:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Extract branch name
        id: get_branch
        run: |
          BRANCH_NAME="${{ github.event.pull_request.head.ref }}"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
      
      - name: Check basic rules
        run: |
          BRANCH="${{ steps.get_branch.outputs.branch_name }}"
          
          # 1. –ù–µ –ø—É—Å—Ç–æ–µ
          if [[ -z "$BRANCH" ]]; then
            echo "‚ùå Branch name is empty"
            exit 1
          fi
          
          # 2. –ù–µ –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –Ω–∞ - –∏–ª–∏ /
          if [[ "$BRANCH" == *"-" ]] || [[ "$BRANCH" == *"/" ]]; then
            echo "‚ùå Branch name must not end with hyphen or slash"
            exit 1
          fi
          
          # 3. –¢–æ–ª—å–∫–æ lowercase, —Ü–∏—Ñ—Ä—ã, / –∏ -
          if [[ ! "$BRANCH" =~ ^[a-z0-9/-]+$ ]]; then
            echo "‚ùå Only lowercase, numbers, hyphens and slashes allowed"
            exit 1
          fi
          
          echo "‚úÖ Basic rules passed"
      
      - name: Check branch format (–ù–û–í–´–ï –ü–†–ê–í–ò–õ–ê –î–õ–Ø –ù–ê–®–ï–ì–û –ü–†–û–ï–ö–¢–ê)
        run: |
          BRANCH="${{ steps.get_branch.outputs.branch_name }}"
          
          # –ü—Ä–∞–≤–∏–ª–∞ –¥–ª—è –Ω–∞—à–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞
          # 1. –î–æ–ª–∂–Ω–æ –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å —Ç–∏–ø–∞
          # 2. –ú–æ–∂–Ω–æ —É–∫–∞–∑—ã–≤–∞—Ç—å scope (frontend/backend)
          regex='^(feature|fix|hotfix|docs|chore|refactor|test)(/(frontend|backend))?/[a-z0-9]+(-[a-z0-9]+)*$'
          
          if [[ "$BRANCH" =~ $regex ]]; then
            echo "‚úÖ Branch format is correct"
            echo "Branch type: $(echo $BRANCH | cut -d'/' -f1)"
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–ª–∏–Ω—É
            WORD_COUNT=$(echo "$BRANCH" | tr '/-' ' ' | wc -w)
            if [[ $WORD_COUNT -lt 2 ]] || [[ $WORD_COUNT -gt 5 ]]; then
              echo "‚ö†Ô∏è  Warning: $WORD_COUNT words (recommended 2-5 words)"
            fi
          else
            echo "‚ùå Invalid branch format for this project"
            echo ""
            echo "üìå Expected formats:"
            echo "  feature/frontend/landing-page"
            echo "  fix/backend/auth-bug"
            echo "  docs/add-readme"
            echo "  chore/update-deps"
            echo "  refactor/frontend/components"
            echo "  hotfix/video-crash"
            echo ""
            echo "üìå Rules:"
            echo "  - Start with: feature|fix|hotfix|docs|chore|refactor|test"
            echo "  - Optional scope: /frontend or /backend"
            echo "  - Description: lowercase-with-hyphens"
            exit 1
          fi